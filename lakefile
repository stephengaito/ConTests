-- A Lua Lakefile

local tInsert    = table.insert

local docDir     = 't-contests/doc/context/third/contests'
local moduleDir  = 't-contests/tex/context/third/contests'

local contextDoc = 'cd t-contests/doc/context/third/contests ; context contests.tex'

local docFiles = {
  'contests.tex',
  'overview.tex',
  'preamble.tex',
  'testSuites.tex',
  'mkivTests.tex',
  'luaTests.tex',
  'cTests.tex',
  'conclusion.tex',
}

local srcFiles = {
  't-contests.mkiv',
  't-contests.lua',
  't-contests.h',
  't-contests-cTests.lua',
  't-contests-templates.lua',
}

-------------------------------------
-- ADD build targets for each srcFile

local buildTargets = {}

tInsert(buildTargets, target(
  'build/t-contests.mkiv',
  docFiles,
  contextDoc
))

tInsert(buildTargets, target(
  'build/t-contests.lua',
  docFiles,
  contextDoc
))

tInsert(buildTargets, target(
  'build/t-contests.h',
  docFiles,
  contextDoc
))

tInsert(buildTargets, target(
  'build/t-contests-cTests.lua',
  docFiles,
  contextDoc
))

tInsert(buildTargets, target(
  'build/t-contests-templates.lua',
  docFiles,
  contextDoc
))

------------------------------------
-- ADD diff targets for each srcFile

local diffTargets = {}

tInsert(diffTargets, target(
  'diff-t-contests.mkiv',
  'build/t-contests.mkiv',
  'diff build/t-contests.mkiv t-contests/tex/context/third/contests/t-contests.mkiv'
))

tInsert(diffTargets, target(
  'diff-t-contests.lua',
  'build/t-contests.lua',
  'diff build/t-contests.lua t-contests/tex/context/third/contests/t-contests.lua'
))

tInsert(diffTargets, target(
  'diff-t-contests.h',
  'build/t-contests.h',
  'diff build/t-contests.h t-contests/tex/context/third/contests/t-contests.h'
))

tInsert(diffTargets, target(
  'diff-t-contests-cTests.lua',
  'build/t-contests-cTests.lua',
  'diff build/t-contests-cTests.lua t-contests/tex/context/third/contests/t-contests-cTests.lua'
))

tInsert(diffTargets, target(
  'diff-t-contests-templates.lua',
  'build/t-contests-templates.lua',
  'diff build/t-contests-templates.lua t-contests/tex/context/third/contests/t-contests-templates.lua'
))

---------------------------------------
-- ADD install targets for each srcFile

local installTargets = {}

tInsert(installTargets, target(
  't-contests/tex/context/third/contests/t-contests.mkiv',
  'build/t-contests.mkiv',
  'cp build/t-contests.mkiv t-contests/tex/context/third/contests/t-contests.mkiv'
))

tInsert(installTargets, target(
  't-contests/tex/context/third/contests/t-contests.lua',
  'build/t-contests.lua',
  'cp build/t-contests.lua t-contests/tex/context/third/contests/t-contests.lua'
))

tInsert(installTargets, target(
  't-contests/tex/context/third/contests/t-contests.h',
  'build/t-contests.h',
  'cp build/t-contests.h t-contests/tex/context/third/contests/t-contests.h'
))

tInsert(installTargets, target(
  't-contests/tex/context/third/contests/t-contests-cTests.lua',
  'build/t-contests-cTests.lua',
  'cp build/t-contests-cTests.lua t-contests/tex/context/third/contests/t-contests-cTests.lua'
))

tInsert(installTargets, target(
  't-contests/tex/context/third/contests/t-contests-templates.lua',
  'build/t-contests-templates.lua',
  'cp build/t-contests-templates.lua t-contests/tex/context/third/contests/t-contests-templates.lua'
))

-------------------------------
-- ADD targets for the lakefile

tInsert(buildTargets, target(
  'build/lakefile',
  docFiles,
  contextDoc
))

tInsert(diffTargets, target(
  'diff-lakefile',
  'build/lakefile',
  'diff build/lakefile lakefile'
))

tInsert(installTargets, target(
  'lakefile',
  'build/lakefile',
 'cp build/lakefile lakefile'
))


-----------------------------
-- ADD targets for all CTests

local testTargets = {}

---------------------------------------
-- ADD targets for CTests allCTests

tInsert(buildTargets, target(
  'build/allCTests.c',
  docFiles,
  contextDoc
))

c.program{
  'build/allCTests',
  src={ 'allCTests.c' },
  cdir='build',
  needs='lua5.2'
}

tInsert(testTargets, target(
  'build/allCTests-results.lua',
  'build/allCTests',
  './build/allCTests'
))


target('tests', testTargets)

target('install', installTargets)
target('diff', diffTargets)
default(buildTargets)