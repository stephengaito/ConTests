% A ConTeXt document [master document: contests.tex]

\startchapter[title=MkIV Unit Testing]

We will eventually include MkIV unit testing.

\section[title=Test cases]

\def\startConTest{\relax}
\def\stopConTest{\relax}

\startMkIVCode

\def\startConTest{
  \directlua{thirddata.contests.startConTests()}
}

\def\stopConTest{
  \directlua{thriddata.contests.stopConTests()}
}

\stopMkIVCode

\startLuaCode

function contests.startConTestTestCase()
  -- save logging....
  -- turn logging to no-stop/batch
end

function contests.stopConTestTestCase()
  -- turn logging back to original value
end

local function conTestShowErrorHook()
  local stats = tests.stats.mkiv
  if not stats.shouldFail then
    -- curCase failed
  end
end

function contests.preAssertConTest(shouldFail)
  local stats = tests.stats.mkiv
  stats.attempted = stats.attempted + 1
  stats.shouldFail = shouldFail
end

function contests.postAssertConTest()
  local stats = tests.stats.mkiv
  stats.shouldFail = false
end

function contests.startConTests()
  local id, err =
    callback.register('show_error_hook', conTestShowErrorHook)
end

function contests.stopConTests()
  local id, err = callback.register('show_error_hook', nil)
end

\stopLuaCode

\section[title=Assertions]

As with the implementation of both the LuaTests and CTests, the heart of 
the ConTests is the ability to throw and capture errors. In this case it 
will be \TeX\ errors, when run, a TestCase will capture all \TeX\ errors 
and provide a report of where those errors happened. 

\startTestSuite[assertThrowsError]

\stopTestSuite

\startTestSuite[assertDoesNotThrowError]

\stopTestSuite

\stopchapter