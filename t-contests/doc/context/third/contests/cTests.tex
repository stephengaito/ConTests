% A ConTeXt document [master document: contests.tex]

\startchapter[title=C Unit Testing]

We will eventually include a collection of C unit tests.

\definetyping[CHeader]
\definetyping[CCode]

\startMkIVCode
\usemodule[high-cpp]

\definetyping[CTest]
\setuptyping[CTest][option=cpp]

\let\oldStopCTest=\stopCTest
\def\stopCTest{%
  \oldStopCTest%
  \directlua{thirddata.contests.addCTest('_typing_')}
}

\def\createCTestFile[#1]{%
  \relax
}
\stopMkIVCode

\startLuaCode
function contests.addCTest(bufferName)
  local bufferContents = buffers.getcontent(bufferName):gsub("\13", "\n")
  local suite = tests.curSuite
  local case  = suite.curCase
  case.ansiC  = case.ansiC or {}
  tInsert(case.ansiC, bufferContents)
end

function contests.collectCTest()

end
\stopLuaCode

\startCHeader

typedef struct TestCase_struc TestCase;

typedef void (*TestCaseFunc)(TestCase*);

struct TestCase_struc {
  char*         desc;
  TestCaseFunc  testCaseFunc;
  int           failed;
  const char*   message;
  jmp_buf      *jumpBuf;
};

\stopCHeader

\startCCode

void TestCaseRun(TestCase *tc) {
  jmp_buf jumpBuf;
  tc->jumpBuf = &jumpBuf;
  (tc->testCaseFunc)(tc);
  tc->jumpBuf = 0;
}

static void CTFailLongJump(TestCase *tc,
                           const char* fileName,
                           int lineNum,
                           const char* message) {
  // do something with the fileName, lineNum and message
  // tc->message = something
  //
  // Now do a long jump back to the TestCaseFunc
  //
  if (tc->jumpBuf) longjump(*(tc->jumpBuf), 0);
}

\stopCCode

\section[title=Assertions]

\startTestSuite[assertFail]

\startCHeader
  // what do we do here?

\stopCHeader

\stopTestSuite

\startTestSuite[assertIntTrue]
\startCHeader
  // what do we do here?

\stopCHeader

\stopTestSuite

\startTestSuite[assertIntFalse]

\stopTestSuite

\startTestSuite[assertIntEquals]

\stopTestSuite

\startTestSuite[assertIntNotEquals]

\stopTestSuite

\startTestSuite[assertPrtNull]

\stopTestSuite

\startTestSuite[assertPtrNotNull]

\stopTestSuite

\startTestSuite[assertPtrEquals]

\stopTestSuite

\startTestSuite[assertPtrNotEquals]

\stopTestSuite

\startTestSuite[assertStrEmpty]

\stopTestSuite

\startTestSuite[assertStrNotEmpty]

\stopTestSuite

\startTestSuite[assertStrEquals]

\stopTestSuite

\startTestSuite[assertStrNotEquals]

\stopTestSuite

\startTestSuite[assertDblEquals]

\stopTestSuite

\startTestSuite[assertDblNotEqals]

\stopTestSuite

\startTestSuite[assert]

\stopchapter