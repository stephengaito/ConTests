% A ConTeXt document [master document: contests.tex]

\startchapter[title=Lua Unit Testing]

We make extensive use of ideas in the design of the LunaTest Lua unit 
testing framework which is in turn inspired by the LUnit assertion 
interface. We tailor these ideas for use \emph{inside} \ConTeXt. 

\section[title=Test cases]

% temporarily include this in the main document
% until the actual module files stabilize
\definetyping[LuaTest]
\setuptyping[LuaTest][option=lua]

\startMkIVCode

\definetyping[LuaTest]
\setuptyping[LuaTest][option=lua]

\stopMkIVCode

\section[title=Assertions]

\startLuaCode

local fmt = string.format

function reportAssertion(theCondition, aMessage, theReason)
  -- we do not need to do anything unless theCondition if false!
  if not theCondition then
    local test     = { }
    test.message   = aMessage
    test.reason    = theReason
    test.condition = theCondition
    local info     = debug.getinfo(2,'l')
    test.line      = info.currentline
    error(test, 0) -- throw an error to be captured by an error_handler
  end
end

function runTest(bufferName)

end

\stopLuaCode

\startTestSuite[title=assert_throwsError]

\startLuaCode
function assert_throwsError(aFunction, aMessage, ...)
  local ok, err = pcall(aFunction, ...)
  return reportAssertion(
    ok,
    aMessage,
    fmt("Expected %s to throw an error.", TS(aFunction), TS(err))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_throwsNoError]

\startLuaCode
function assert_throwsNoError(aFunction, aMessage, ...)
  local ok, err = pcall(aFunction, ...)
  return reportAssertion(
    not ok,
    aMessage,
    fmt("Expected %s not to throw an error (%s).", TS(aFunction), TS(err))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_fail]

\startLuaCode
function assert_fail(aMessage)
  return reportAssertion(
    false,
    aMessage,
    "(Failed)"
  )
end
\stopLuaCode

\startTestCase[title=should fail]

\startLuaTest
  something
\stopLuaTest

\stopTestCase
\stopTestSuite

\startTestSuite[title=assert_isBoolean]

\startLuaCode
function assert_isBoolean(anObj, aMessage)
  return reportAssertion(
    type(anObj) == 'boolean',
    aMessage,
    fmt("Expected %s to be a boolean.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotBoolean]

\startLuaCode
function assert_isNotBoolean(anObj, aMessage)
  return reportAssertion(
    type(anObj) ~= 'boolean',
    aMessage,
    fmt("Expected %s to not be a boolean.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isTrue]

\startLuaCode
function assert_isTrue(aBoolean, aMessage)
  return reportAssertion(
    aBoolean,
    aMessage,
    fmt("Expected true, got %s.", TS(aBoolean))
  )
end
\stopLuaCode

\startTestCase[title=should succeed]

\startLuaTest
  something else
\stopLuaTest

\stopTestCase
\stopTestSuite

\startTestSuite[title=assert_isFalse]

\startLuaCode
function assert_isFalse(aBoolean, aMessage)
  return reportAssertion(
    not aBoolean,
    aMessage,
    fmt("Expected false, got %s.", TS(aBoolean))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNil]

\startLuaCode
function assert_isNil(anObj, aMessage)
  return reportAssertion(
    anObj == nil,
    aMessage,
    fmt("Expected nil, got %s.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotNil]

\startLuaCode
function assert_isNotNil(anObj, aMessage)
  return reportAssertion(
    anObj ~= nil,
    aMessage,
    fmt("Expected non-nil, got %s.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isEqual]

\startLuaCode
function assert_isEqual(anObj, expected, aMessage)
  return reportAssertion(
    anObj == expected,
    aMessage,
    fmt("Expected %s to equal %s.", TS(expected), TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isEqualWithIn]

\startLuaCode
function assert_isEqualWithIn(anObj, expected, tolerance, aMessage)
  return reportAssertion(
    ????,
    aMessage,
    fmt("Expected %s to equal %s with tolerance %s.",
      TS(anObj), TS(expected), TS(tolerance))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotEqual]

\startLuaCode
function assert_isNotEqual(anObj, expected, aMessage)
  return reportAssertion(
    anObj ~= expected,
    aMessage,
    fmt("Expected %s to not equal %s.", TS(expected), TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotEqualWithIn]
\startLuaCode
function assert_isNotEqualWithIn(anObj, expected, tolerance, aMessage)
  return reportAssertion(
    ????,
    aMessage,
    fmt("Expected %s to not equal %s with tolerance %s.",
      TS(anObj), TS(expected), TS(tolerance))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNumber]

\startLuaCode
function assert_isNumber(anObj, aMessage)
  return reportAssertion(
    type(anObj) == 'number',
    aMessage,
    fmt("Expected %s to be a number.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isGT]

\startLuaCode
function assert_isGT(objA, objB, aMessage)
  return reportAssertion(
    objA > objB,
    aMessage,
    fmt("Expected %s > %s.", TS(objA), TS(objB))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isGTE]

\startLuaCode
function assert_isGTE(objA, objB, aMessage)
  return reportAssertion(
    objA >= objB,
    aMessage,
    fmt("Expected %s >= %s.", TS(objA), TS(objB))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isLT]

\startLuaCode
function assert_isLT(objA, objB, aMessage)
  return reportAssertion(
    objA < objB,
    aMessage,
    fmt("Expected %s < %s.", TS(objA), TS(objB))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isLTE]

\startLuaCode
function assert_isLTE(objA, objB, aMessage)
  return reportAssertion(
    objA <= objB,
    aMessage,
    fmt("Expected %s <= %s.", TS(objA), TS(objB))
  )
end
\stopLuaCode


\stopTestSuite

\startTestSuite[title=assert_isNotNumber]

\startLuaCode
function assert_isNotNumber(anObj, aMessage)
  return reportAssertion(
    type(anObj) ~= 'number',
    aMessage,
    fmt("Expected %s to be a number.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isString]

\startLuaCode
function assert_isString(anObj, aMessage)
  return reportAssertion(
    type(anObj) == 'string',
    aMessage,
    fmt("Expected [%s] to be a string.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_matches]

\startLuaCode
function assert_matches(anObj, aPattern, aMessage)
  return reportAssertion(
    anObj:matches(aPattern),
    aMessage,
    ftm("Expected [%s] to match [%s].", TS(anObj), TS(aPattern))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_doesNotMatch]

\startLuaCode
function assert_doesNotMatch(anObj, aPattern, aMessage)
  return reportAssertion(
    not anObj:matches(aPattern),
    aMessage,
    fmt("Expected [%s] to not match [%s].", TS(anObj), TS(aPattern))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_length]

\startLuaCode
function assert_length(anObj, aLength, aMessage)
  return reportAssertion(
    #anObj == aLength,
    aMessage,
    fmt("Expected %s to have length %s.", TS(anObj), TS(aMessage))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotLength]

\startLuaCode
function assert_isNotLength(anObj, aLength, aMessage)
  return reportAssertion(
    #anObj ~= aLength,
    aMessage,
    fmt("Expected %s to not have length %s.", TS(anObj), TS(aMessage))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotString]

\startLuaCode
function assert_isNotString(anObj, aMessage)
  return reportAssertion(
    type(anObj) ~= 'string',
    aMessage,
    fmt("Expected [%s] to not be a string.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isTable]

\startLuaCode
function assert_isTable(anObj, aMessage)
  return reportAssertion(
    type(anObj) == 'table',
    aMessage,
    fmt("Expected %s to be a table.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_hasKey]

\startLuaCode
function assert_hasKey(anObj, aKey, aMessage)
  return reportAssertion(
    anObj[aKey] ~= nil,
    aMessage,
    fmt("Expected %s to have the key %s.", TS(anObj), TS(aKey))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_doesNotHaveKey]

\startLuaCode
function assert_doesNotHaveKey(anObj, aKey, aMessage)
  return reportAssertion(
    anObj[aKey] == nil,
    aMessage,
    fmt("Expected %s to not have the key %s.", TS(anObj), TS(aKey))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotTable]

\startLuaCode
function assert_isNotTable(anObj, aMessage)
  return reportAssertion(
    type(anObj) ~= 'table',
    aMessage,
    fmt("Expected %s to not be a table.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isFunction]

\startLuaCode
function assert_isFunction(anObj, aMessage)
  return reportAssertion(
    type(anObj) == 'function',
    aMessage,
    fmt("Expected %s to be a function.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotFunction]

\startLuaCode
function assert_isNotFunction(anObj, aMessage)
  return reportAssertion(
    type(anObj) ~= 'function',
    aMessage,
    fmt("Expected %s to not be a function.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isUserData]

\startLuaCode
function assert_isUserData(anObj, aMessage)
  return reportAssertion(
    type(anObj) == 'userdata',
    aMessage,
    fmt("Expected %s to be user data.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotUserData]

\startLuaCode
function assert_isNotUserData(anObj, aMessage)
  return reportAssertion(
    type(anObj) ~= 'userdata',
    aMessage,
    fmt("Expected %s to not be user data.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_hasMetaTable]

\startLuaCode
function assert_hasMetaTable(anObj, aMessage)
  return reportAssertion(
    getMetaTable(anObj) ~= nil,
    aMessage,
    fmt("Expected %s to have a meta table.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_metaTableEquals]

\startLuaCode
function assert_metaTableEqual(anObj, aMetaTable, aMessage)
  return reportAssertion(
    getMetaTable(anObj) == aMetaTable,
    aMessage,
    fmt("Expected %s to have the meta table %s.", TS(anObj), TS(aMetaTable))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_metaTableNotEqual]

\startLuaCode
function assert_metaTableNotEqual(anObj, aMetaTable, aMessage)
  return reportAssertion(
    getMetaTable(anObj) ~= aMetaTable,
    aMessage,
    fmt("Expected %s to not have the meta table %s.", TS(anObj), TS(aMetaTable))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_doesNotHaveMetaTable]

\startLuaCode
function assert_hasMetaTable(anObj, aMessage)
  return reportAssertion(
    getMetaTable(anObj) == nil,
    aMessage,
    fmt("Expected %s to not have a meta table.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isThread]

\startLuaCode
function assert_isThread(anObj, aMessage)
  return reportAssertion(
    type(anObj) == 'thread',
    aMessage,
    fmt("Expected %s to be a thread.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\startTestSuite[title=assert_isNotThread]

\startLuaCode
function assert_isNotThread(anObj, aMessage)
  return reportAssertion(
    type(anObj) ~= 'thread',
    aMessage,
    fmt("Expected %s to not be a thread.", TS(anObj))
  )
end
\stopLuaCode

\stopTestSuite

\stopchapter