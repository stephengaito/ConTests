% A ConTeXt document [master document: contests.tex]

\startchapter[title=Unit Test Suites]

Note that you can not use \type{"} in the \type{\startTestSuite} or 
\type{\startTestCase} arguments. 

\startMkIVCode

\def\startTestSuite[#1]{%
  \startsubsection[title=Test Suite: #1]
  \directlua{thirddata.contests.startTestSuite("#1")}
}

\def\stopTestSuite{%
  \stopsubsection%
  \directlua{thirddata.contests.collectTestSuite()}
}

\def\startTestCase[#1]{%
  \startsubsubsection[title=Test Case: #1]
  \directlua{thirddata.contests.startTestCase("#1")}
}

\def\stopTestCase{%
  \stopsubsubsection%
  \directlua{thirddata.contests.collectTestCase()}
}

\stopMkIVCode

\startLuaCode

local function initSuite()
  local curSuite = {}
  curSuite.passed = true
  curSuite.cases  = {}
  return curSuite
end

function contests.startTestSuite(aDesc)
  tests.curSuite      = initSuite()
  tests.curSuite.desc = aDesc
end

function contests.collectTestSuite()
  table_insert(tests.suites, tests.curSuite)
  tests.curSuite = initSuite()
end

function contests.startTestCase(aDesc)
  local suite       = tests.curSuite
  suite.curCase     = {}
  local curCase     = suite.curCase
  curCase.passed    = true
  curCase.desc      = aDesc
  curCase.fileName  = status.filename
  curCase.startLine = status.linenumber
end

function contests.collectTestCase()
  local curSuite   = tests.curSuite
  local curCase    = curSuite.curCase
  curCase.lastLine = status.linenumber
  contests.runCurLuaTestCase(curSuite, curCase)
  table_insert(curSuite.cases, curCase)
  curSuite.curCase = {}
end

\stopLuaCode

\stopchapter